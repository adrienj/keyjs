!function(a,b){"use strict";window.Key=function(c){c=c||{},c.models=c.models||{},c.views=c.views||{containers:{},global:{}},c.controllers=c.controllers||{};var d=this,e={call:function(a,b,c){return a.apply(b,c&&[].slice.call(c))},isObject:function(a){return a instanceof Object&&"[object Function]"!=={}.toString.call(a)},isArray:function(a){return a&&"[object Array]"===Object.prototype.toString.call(a)},map:function(a,b){return[].slice.call(a).map(b)},extend:function(a,b,c){for(var d in b)c&&"function"==typeof b[d]||(a[d]=b[d]);return a},addEvent:function(){return document.addEventListener?function(a,b,c){if(a&&a.nodeName||a===window)a.addEventListener(b,c,!1);else if(a&&a.length)for(var d=0;d<a.length;d++)addEvent(a[d],b,c)}:function(a,b,c){if(a&&a.nodeName||a===window)a.attachEvent("on"+b,function(){return c.call(a,window.event)});else if(a&&a.length)for(var d=0;d<a.length;d++)addEvent(a[d],b,c)}}(),localStorage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return console.log("LocalStorage not found"),!1}},isTouchDevice:function(){return"ontouchstart"in window||"onmsgesturechange"in window},ajax:function(a,b,c,d,e){e=new(window.XMLHttpRequest||ActiveXObject)("Microsoft.XMLHTTP"),e.onreadystatechange=function(){4^e.readyState||c(this)},e.open(a,b),e.send(d)}},f={popState:function(a){a.state&&f.load(d.parseUrl(a.state.url),a.state.url,!0)},load:function(a,b,e){e?a=d.parseUrl(b):(a.url=b,history.pushState(a,a.controller,c.base+b)),d.load(a.controller,a.arguments)}},g={path:c.views.path||"tpl/",prefix:c.views.prefix||"key-",containers:{app:c.views.app||"app",main:c.views.main||"main",fallback:document.body},cache:{parse:{},view:{}},getElement:function(a,b){return document.body.querySelector((b||"")+"."+this.prefix+a)},print:function(a,c,d){d.innerHTML=b?new b(a).render(c):a},cacheContainers:function(){e.extend(this.containers,c.views.containers);for(var a in this.containers)this.containers.hasOwnProperty(a)&&"string"==typeof this.containers[a]&&(c.views.containers[a]=this.getElement(this.containers[a])||this.containers.fallback)},render:function(a,b,c,d){var f=this.getElement(a,"script");f?(this.print(f.innerHTML,b,c),d&&d()):this.cache.view[a]?(this.print(this.cache.view[a],b,c),d&&d()):e.ajax("get",this.path+a+".html",function(e){404!==e.status&&(g.print(e.responseText,b,c),g.cache.view[a]=e.responseText),d&&d()})},parse:function(b,d){var f,g,h=new RegExp(".*?"+this.prefix+"([\\w_\\-]+)[\\s\\W]*?");if(b=b||c.views.containers.app,d=d||{},[].slice.call(b.querySelectorAll("*[class*="+this.prefix+"]")).forEach(function(a){(f=a.className.match(h))&&(g=f[1],d[g]?(e.isArray(d[g])||(d[g]=[d[g]]),d[g].push(a)):d[g]=a)}),c.views.jQuery&&a){for(g in c.views.global)c.views.global.hasOwnProperty(g)&&(d[g]=a(document.body.querySelector("."+this.prefix+c.views.global[g])));for(g in c.views.containers)c.views.containers.hasOwnProperty(g)&&(d[g]=a(c.views.containers[g]));for(g in d)d.hasOwnProperty(g)&&(d[g]=a(d[g]))}return this.bindLinks(b),d},bindLinks:function(a){e.map(a.getElementsByTagName("a"),function(a){/^\//.test(a.getAttribute("href"))&&e.addEvent(a,"click",function(a){var b=this.getAttribute("href");f.load(d.parseUrl(b),b),a.preventDefault()})})},clear:function(a){(c.views.containers[a]||c.views.global[a]).innerHTML=""}},h={data:{},schema:{},storageKey:c.storageKey||"key.data",crud:{set:function(a,b){return b||(b=a,a=b.id),e.extend(h.data[this.name][a],b),c.autoSave&&h.save(),this},get:function(a){return"undefined"!=typeof a?h.data[this.name][a]:h.data[this.name]},insert:function(a){var b,d={};for(b in h.schema[this.name])h.schema[this.name].hasOwnProperty(b)&&(d[b]=a[b]||h.schema[this.name][b]);return d.id=h.data[this.name].length,h.data[this.name][d.id]=d,c.autoSave&&h.save(),d},"delete":function(a){return"undefined"!=typeof a?delete h.data[this.name][a]:h.data[this.name]=[],c.autoSave&&h.save(),this}},bind:function(a,b){return this.data[b]=this.data[b]||[],this.schema[b]=e.extend({},a,!0),a.name=b,e.extend(a,this.crud),a},save:function(){e.localStorage&&localStorage.setItem(this.storageKey,JSON.stringify(this.data))},clear:function(){e.localStorage&&localStorage.setItem(this.storageKey,void 0)},restore:function(){var a;e.localStorage&&null!==(a=localStorage.getItem(this.storageKey))&&(this.data=JSON.parse(a))}},i={"default":"index",bind:function(a,b){var f=e.extend({},b);return f.name=a,f.models=c.models,f.load=d.load,c.controllers[a]=f,f},firstLoad:function(a){c.controllers.onload&&(e.extend(c.controllers,{view:g.cache.parse.app,models:c.models,load:d.load}),c.controllers.onload(a))},load:function(a,b,d,f,h){var i=function(){return a.view=g.cache.parse[a.name]=g.parse(h),f||(c.view=a.view),c.controllers.onchange&&(a.view=e.extend(a.view,g.cache.parse.app),c.controllers.onchange.call(a,a)),a.onload&&a.onload.apply(a,b)};return d?i:i()}};return d.parseUrl=function(a){var d,e,f,b=a.split("/").splice(1),c={controller:b.shift(),arguments:[]};for(f in b)if(-1===b[f].indexOf("&"))c.arguments[f]=unescape(b[f]);else{c.arguments[f]={},d=b[f].split("&");for(e in d)c.arguments[f][d[e].split("=")[0]]=unescape(d[e].split("=")[1])}return c},d.load=function(a,b,d){var f,h,j;return a||(a=c.controllers.default||i.default),b&&!e.isArray(b)&&(b=[b]),(f=c.controllers[a])&&f.data&&(c.controllers.current=a,h=f.data.apply(f,b)),j=c.views.containers[d]||c.views.containers.main||c.views.containers.app,f=c.controllers[a],f?g.render(a,h,j,i.load(f,b,!0,d,j)):(g.render(a,h,j),c.controllers.onchange&&(c.controllers.view=g.cache.parse.app,c.controllers.onchange())),h},d.start=function(){var a,b,d={};c.load=this.load,c.clear=g.clear,c.helpers=c.helpers?e.extend(c.helpers,e):e,g.cacheContainers(),g.cache.parse.app=g.parse(),window.addEventListener("popstate",f.popState),c.autoLoad&&h.restore();for(a in c.models)c.models.hasOwnProperty(a)&&h.bind(c.models[a],a);for(a in c.controllers)c.controllers.hasOwnProperty(a)&&e.isObject(c.controllers[a])&&i.bind(a,c.controllers[a]);return c.base&&"/"!==(b=window.location.pathname.split(c.base)[1])?(d=this.parseUrl(b),i.firstLoad(c.controllers[d.controller]),f.load(d,b)):(i.firstLoad(c.controllers[a]),this.load(c.controllers&&c.controllers.default||"index")),this},("undefined"==typeof c.autoStart||c.autoStart)&&this.start(),this}}(window.jQuery,window.t);